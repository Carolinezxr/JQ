# 导入函数库
import jqdata
import datetime
import numpy as np 
from jqfactor import get_factor_values

# 策略初始化
def initialize(context):
    set_benchmark('000906.XSHG')
    set_option('use_real_price', True)
    log.set_level('order', 'error')
    run_monthly(market_open,-1, time='open', reference_security='000906.XSHG')
    
    
# 每月开盘运行一次， 按照上个月最后一个交易日的因子值进行调仓
def market_open(context):
    for stock in context.portfolio.positions.keys():
        order_target(stock,0)
        
    date = context.previous_date
    stock_list= get_index_stocks('000906.XSHG')
 

    '''获取因子值'''
    factor_data = get_factor_values(stock_list, factors=['size'], start_date=date, end_date=date)['size'].iloc[-1]
    factor_data_sort = factor_data.sort_values()
    #print(factor_data_sort)
    factor_data_sort.dropna=factor_data_sort.dropna()
    n = round(len(factor_data_sort.dropna)*0.1)

    buy_list = factor_data_sort[0:n].index.tolist() #买入因子值最小的10%只股票  
    cash = context.portfolio.total_value/n
    for stock in buy_list:
        order_target_value(stock,cash)
        log.info("Buying %s" % (stock_to_buy))
        
    sell_list = factor_data_sort[::-1][:n].index.tolist() #卖出因子值最大的10%只股票
    for stock in sell_list:
        order_target_value(stock,0)
        log.info("Selling %s" % (stock_to_sell))
